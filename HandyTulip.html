<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ‰‹åŠ¿ç§èŠ± â€” CSS éƒé‡‘é¦™</title>
<!-- SEO åŸºç¡€ä¿¡æ¯ -->
<link rel="canonical" href="https://holatiger.com/HandyTulip.html" />
<meta name="description" content="æ‰‹åŠ¿ç§èŠ±ï¼šä½¿ç”¨æ‘„åƒå¤´è¯†åˆ«æ‰‹åŠ¿ï¼Œåœ¨å±å¹•ç§ä¸‹éƒé‡‘é¦™ã€‚çº¯ CSS åŠ¨ç”»ä¸ MediaPipe æ‰‹åŠ¿è¯†åˆ«æ¼”ç¤ºï¼Œè½»ç›ˆè€Œæœ‰è¶£çš„äº¤äº’å®éªŒã€‚" />
<meta name="keywords" content="æ‰‹åŠ¿è¯†åˆ«, éƒé‡‘é¦™, CSS åŠ¨ç”», MediaPipe, æ‘„åƒå¤´, äº’åŠ¨å®éªŒ, Web" />
<meta name="author" content="HolaTiger" />
<meta name="robots" content="index, follow" />
<meta name="googlebot" content="index, follow" />
<meta name="theme-color" content="#0b0d10" />
<meta name="referrer" content="no-referrer-when-downgrade" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

<!-- Open Graph / Facebook -->
<meta property="og:site_name" content="HolaTiger" />
<meta property="og:locale" content="zh_CN" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://holatiger.com/HandyTulip.html" />
<meta property="og:title" content="æ‰‹åŠ¿ç§èŠ± â€” CSS éƒé‡‘é¦™" />
<meta property="og:description" content="ä½¿ç”¨æ‘„åƒå¤´è¯†åˆ«æ‰‹åŠ¿åœ¨å±å¹•ç§ä¸‹éƒé‡‘é¦™ï¼Œçº¯ CSS åŠ¨ç”»ä¸ MediaPipe æ‰‹åŠ¿è¯†åˆ«çš„äº’åŠ¨æ¼”ç¤ºã€‚" />
<meta property="og:image" content="https://holatiger.com/assets/images/social/holatiger-svg-studio-1200x630.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="æ‰‹åŠ¿ç§èŠ± â€” CSS éƒé‡‘é¦™" />
<meta name="twitter:description" content="ä½¿ç”¨æ‘„åƒå¤´è¯†åˆ«æ‰‹åŠ¿åœ¨å±å¹•ç§ä¸‹éƒé‡‘é¦™ï¼Œçº¯ CSS åŠ¨ç”»ä¸ MediaPipe æ‰‹åŠ¿è¯†åˆ«çš„äº’åŠ¨æ¼”ç¤ºã€‚" />
<meta name="twitter:image" content="https://holatiger.com/assets/images/social/holatiger-svg-studio-1200x630.png" />
<meta name="twitter:image:alt" content="æ‰‹åŠ¿ç§èŠ±äº’åŠ¨å®éªŒé¢„è§ˆå›¾" />

<!-- ç»“æ„åŒ–æ•°æ®ï¼šWebPage -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "æ‰‹åŠ¿ç§èŠ± â€” CSS éƒé‡‘é¦™",
  "url": "https://holatiger.com/HandyTulip.html",
  "inLanguage": "zh-CN",
  "description": "æ‰‹åŠ¿ç§èŠ±ï¼šä½¿ç”¨æ‘„åƒå¤´è¯†åˆ«æ‰‹åŠ¿ï¼Œåœ¨å±å¹•ç§ä¸‹éƒé‡‘é¦™ã€‚çº¯ CSS åŠ¨ç”»ä¸ MediaPipe æ‰‹åŠ¿è¯†åˆ«æ¼”ç¤ºï¼Œè½»ç›ˆè€Œæœ‰è¶£çš„äº¤äº’å®éªŒã€‚",
  "dateModified": "2025-11-10T03:28:54Z",
  "isPartOf": {
    "@type": "WebSite",
    "name": "HolaTiger",
    "url": "https://holatiger.com/"
  }
}
</script>
<style>
  :root{
    --bg: #0b0d10;
    --ground: #061018;
    --stem: #2d7a3e;
    --leaf: #236033;
    --petal1: #ff5d8f;
    --petal2: #ff8fb3;
    --petal3: #ff2d6a;
    /* ç»å…¸éƒé‡‘é¦™ï¼ˆæ©™é»„é…è‰²ä¸æ›´ç»†èŒå¶ï¼‰ */
    --classic-stem: #2e7d32;
    --classic-leaf: #2a6a36;
    --tulip-orange1: #ff9d2e;
    --tulip-orange2: #ff7a1a;
    --tulip-orange3: #ffc15c;
  }
  html,body{height:100%; margin:0; background:var(--bg); font-family:system-ui, sans-serif; color:#fff}
  #app{
    position:relative;
    width:100%;
    height:100vh;
    overflow:hidden;
  }

  /* è§†é¢‘å’Œ canvas éšè—ï¼ˆæˆ–å¯è®¾ç½®ä½ä¸é€æ˜åº¦ç”¨äºè°ƒè¯•ï¼‰ */
  video#webcam {
    position:absolute;
    left:0; top:0;
    width:100%; height:100%;
    object-fit:cover;
    transform: scaleX(-1); /* é•œåƒï¼Œå’Œç”¨æˆ·æœŸæœ›ä¸€è‡´ */
    opacity:0; /* éšè—æ‘„åƒå¤´ */
    pointer-events:none;
  }
  canvas#debug {
    position:absolute;
    left:0; top:0;
    width:100%; height:100%;
    pointer-events:none;
    mix-blend-mode:screen;
    /* ä¸ºäº†ä¸é•œåƒè§†é¢‘å¯¹é½ï¼ŒåŒæ—¶é•œåƒè°ƒè¯•ç”»å¸ƒ */
    transform: scaleX(-1);
    opacity:0.6; /* æ˜¾ç¤ºæŒ‡å°–/æ‰‹æŒæ ‡è®° */
  }

  /* åœ°é¢ */
  .ground {
    position:absolute;
    left:0;
    right:0;
    bottom:0;
    height:12vh;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)), var(--ground);
    box-shadow: 0 -8px 30px rgba(0,0,0,0.7) inset;
    z-index:5;
  }

  /* å®¹å™¨æ”¾èŠ±ï¼ˆç»å¯¹å®šä½ï¼‰  */
  .garden {
    position:absolute;
    left:0; top:0;
    width:100%; height:100%;
    pointer-events:none;
    z-index:10;
  }

  /* å•æœµèŠ±çš„å®¹å™¨ */
  .flower {
    position:absolute;
    bottom:calc(12vh - 4px); /* ä»åœ°é¢ä¹‹ä¸Šå¼€å§‹ç”Ÿé•¿ */
    width:80px;
    height:0; /* åˆå§‹é«˜åº¦ä¸º 0ï¼Œé€šè¿‡åŠ¨ç”»å¢é•¿ stemï¼Œç”¨ transform æ§åˆ¶ */
    transform-origin: bottom center;
    pointer-events:none;
  }

  /* æŠ“å–çŠ¶æ€ï¼šå…è®¸é€šè¿‡ top/left è·Ÿéšæ‰‹éƒ¨ä½ç½® */
  .flower.picked {
    bottom:auto;
  }

  /* èŒï¼ˆä½¿ç”¨ä¼ªå…ƒç´ ï¼‰ */
  .flower .stem {
    position:absolute;
    left:50%;
    transform: translateX(-50%) rotate(var(--stem-bend, 0deg));
    bottom:0;
    width:6px;
    height: var(--stem-h, 0px);
    background: linear-gradient(180deg, var(--stem), #1b5b2f);
    border-radius: 6px;
    transform-origin: bottom center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  }
  /* ç»å…¸éƒé‡‘é¦™ï¼šç»†èŒæ›´é«˜ã€ä¸¤ä¾§é•¿å¶ã€é—­åˆèŠ±è‹ */
  .flower.tulip-classic .stem{
    width:5px;
    background: linear-gradient(180deg, var(--classic-stem), #1c5a2b);
  }
  .flower.tulip-classic .leaf-left,
  .flower.tulip-classic .leaf-right{
    bottom:10%;
    opacity:0.96;
    background: linear-gradient(135deg, var(--classic-leaf), #1f6b3a);
  }
  .flower.tulip-classic .leaf-left{
    left:calc(50% - 16px);
    width: var(--leafL-w, 26px); height: var(--leafL-h, 124px);
    border-radius: 50% 40% 20% 80% / 80% 40% 60% 30%;
    transform-origin: left bottom;
    transform: rotate(var(--leafL-rot, -6deg)) translateX(var(--leafL-tx, -10px)) scale(var(--leafL-scale, 0.96));
  }
  .flower.tulip-classic .leaf-right{
    left:calc(50% + 6px);
    width: var(--leafR-w, 24px); height: var(--leafR-h, 164px);
    border-radius: 40% 60% 80% 20% / 30% 60% 80% 40%;
    transform-origin: right bottom;
    transform: rotate(var(--leafR-rot, 8deg)) translateX(var(--leafR-tx, 6px)) scale(var(--leafR-scale, 1.0));
  }
  .flower.tulip-classic .bulb{
    /* ä½¿èŠ±è‹è·ŸéšèŒé¡¶ï¼š--stem-h ä¸ºèŒé«˜åº¦ï¼ˆåƒç´ ï¼‰ */
    left: calc(50% + var(--stem-tip-x, 0px));
    bottom: calc(var(--stem-tip-y, var(--stem-h, 120px)) - 6px);
    width: var(--bulb-w, 32px); height: var(--bulb-h, 56px);
    transform-origin: center bottom;
    transform: translateX(-50%) scale(var(--bulb-scale, 1));
  }
  .flower.tulip-classic .bud-left,
  .flower.tulip-classic .bud-right{
    position:absolute;
    bottom:0; width:26px; height:56px;
    transform-origin: bottom center;
    border-radius: 60% 60% 40% 40% / 70% 70% 40% 40%;
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
  }
  .flower.tulip-classic .bud-left{
    left:50%; transform: translateX(-78%) rotate(-8deg) scale(1.0);
    background: linear-gradient(180deg, var(--tulip-orange2), var(--tulip-orange3));
  }
  .flower.tulip-classic .bud-right{
    left:50%; transform: translateX(-22%) rotate(8deg) scale(1.0);
    background: linear-gradient(180deg, var(--tulip-orange1), var(--tulip-orange2));
  }
  .flower.tulip-classic .bud-base{
    position:absolute;
    left:50%; bottom:2px;
    transform: translateX(-50%);
    width:10px; height:10px; border-radius:50%;
    background: radial-gradient(circle at 40% 40%, #ff8fb3, #ff5d8f);
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }
  .flower.tulip-classic .center{ display:none; }

  /* å¶å­ï¼ˆä¼ªå…ƒç´ ï¼‰ */
  .flower .leaf-left,
  .flower .leaf-right{
    position:absolute;
    bottom:8%;
    width:34px;
    height:18px;
    background: linear-gradient(135deg, var(--leaf), #1f6b3a);
    border-radius: 50% 20% 60% 40%;
    opacity:0.95;
  }
  .flower .leaf-left{
    left:calc(50% - 22px);
    transform-origin: left center;
    transform: rotate(-30deg) translateX(-12px) scale(0.1);
    box-shadow: -4px 3px 6px rgba(0,0,0,0.2);
  }
  .flower .leaf-right{
    left:calc(50% + 6px);
    transform-origin: right center;
    transform: rotate(30deg) translateX(12px) scale(0.1);
    box-shadow: 4px 3px 6px rgba(0,0,0,0.2);
  }

  /* èŠ±è‹ï¼ˆç”¨å¤šä¸ªä¼ªå…ƒç´ ç»„æˆè¾ƒçœŸå®çš„èŠ±ç“£å±‚ï¼‰ */
  .flower .bulb {
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom: calc(12% + 0px);
    width: 28px;
    height: 28px;
    transform-origin: center bottom;
  }

  /* ä¸‰ä¸ªå±‚æ¬¡çš„ç“£ï¼ˆç”¨ä¼ªå…ƒç´ å®ç°ï¼‰ */
  .bulb .petal {
    position:absolute;
    left:50%;
    bottom:0;
    transform-origin: bottom center;
    width: 32px;
    height: 32px;
    border-radius: 50% 50% 40% 40%;
    background: radial-gradient(circle at 30% 30%, var(--petal2), var(--petal1));
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    transform: translateX(-50%) scale(0.2) rotate(0deg);
    opacity:0.95;
  }
  .bulb .petal.p1{ transform: translateX(-50%) scale(0.22) rotate(0deg); }
  .bulb .petal.p2{ transform: translateX(-50%) scale(0.2) rotate(28deg); background: linear-gradient(180deg, var(--petal1), var(--petal2)); }
  .bulb .petal.p3{ transform: translateX(-50%) scale(0.18) rotate(-28deg); background: linear-gradient(180deg, var(--petal3), var(--petal1)); }
  /* æ‰©å±•èŠ±ç“£è‡³ 5 ç‰‡ï¼Œä»¥ä¾¿æœ€ç»ˆç››å¼€æ›´é¥±æ»¡ */
  .bulb .petal.p4{ transform: translateX(-50%) scale(0.16) rotate(52deg); background: linear-gradient(180deg, var(--petal2), var(--petal3)); }
  .bulb .petal.p5{ transform: translateX(-50%) scale(0.16) rotate(-52deg); background: linear-gradient(180deg, var(--petal2), var(--petal3)); }

  /* ä¸­å¿ƒå°çƒï¼ˆèŠ±å¿ƒï¼‰ */
  .bulb .center{
    position:absolute;
    left:50%;
    bottom:8px;
    transform:translateX(-50%) scale(0.2);
    width:10px; height:10px;
    border-radius:50%;
    background: linear-gradient(180deg,#fff2,#ffd1c8);
    box-shadow: 0 0 8px rgba(255,220,220,0.15) inset;
    opacity:0;
  }

  /* åŠ¨ç”»ï¼šèŒä»åœ°é‡Œé•¿å‡º */
  @keyframes stemGrow {
    0% { height: 0px; }
    100%{ height: var(--stem-h, 120px); }
  }
  /* å¶å¼ å¼€ */
  @keyframes leafOpenLeft {
    0% { transform: rotate(-30deg) translateX(-12px) scale(0.1); opacity:0; }
    60% { transform: rotate(-18deg) translateX(-6px) scale(0.85); opacity:1; }
    100%{ transform: rotate(-10deg) translateX(-2px) scale(1); opacity:1; }
  }
  @keyframes leafOpenRight {
    0% { transform: rotate(30deg) translateX(12px) scale(0.1); opacity:0; }
    60% { transform: rotate(18deg) translateX(6px) scale(0.85); opacity:1; }
    100%{ transform: rotate(10deg) translateX(2px) scale(1); opacity:1; }
  }
  /* èŠ±è‹ç”Ÿé•¿ */
  @keyframes budGrow {
    0% { transform: translateX(-50%) scale(0.2) translateY(18px); opacity:0; }
    70%{ transform: translateX(-50%) scale(0.95) translateY(0); opacity:1; }
    100%{ transform: translateX(-50%) scale(1) translateY(0); opacity:1; }
  }
  /* èŠ±ç“£å¼€ */
  @keyframes bloom {
    0% {
      transform: translateX(-50%) scale(0.6) rotate(0deg) translateY(6px);
      opacity:0.9;
      filter: blur(1.6px);
    }
    40% {
      transform: translateX(-50%) scale(1.05) rotate(0deg) translateY(-6px);
      filter: blur(0.6px);
    }
    100% {
      transform: translateX(-50%) scale(1.0) rotate(0deg) translateY(-12px);
      opacity:1;
      filter: none;
    }
  }

  /* å°†åŠ¨ç”»ç»„åˆåˆ°ç±»ä¸Š */
  .growing .stem {
    animation: stemGrow 900ms ease-out forwards;
  }
  .growing .leaf-left { animation: leafOpenLeft 800ms cubic-bezier(.2,.9,.2,1) forwards; }
  .growing .leaf-right{ animation: leafOpenRight 800ms cubic-bezier(.2,.9,.2,1) forwards; }
  .growing .petal { animation: budGrow 700ms cubic-bezier(.2,.9,.2,1) forwards; }
  .bloom .petal.p1 { animation: bloom 600ms ease-out 0ms forwards; }
  .bloom .petal.p2 { animation: bloom 600ms ease-out 80ms forwards; transform-origin: 50% 80%; }
  .bloom .petal.p3 { animation: bloom 600ms ease-out 140ms forwards; transform-origin: 50% 80%; }
  .bloom .center { animation: bloom 600ms ease-out 180ms forwards; }

  /* é˜¶æ®µæ§åˆ¶ï¼šstage1 ä»…æœ‰èŒï¼›stage2 å‡ºèŠ±è‹ï¼›stage3 å±•å¶ï¼›stage4 å¼€èŠ± */
  .flower.tulip-classic.stage1 .leaf-left,
  .flower.tulip-classic.stage1 .leaf-right,
  .flower.tulip-classic.stage1 .bud-left,
  .flower.tulip-classic.stage1 .bud-right,
  .flower.tulip-classic.stage1 .bud-base,
  .flower.tulip-classic.stage1 .petal{ opacity:0; transform: translateY(12px) scale(0.1); }

  /* é˜¶æ®µ2/3ï¼šèŠ±ç“£éšè—ï¼Œç­‰å¾…æœ€ç»ˆå¼€èŠ± */
  .flower.tulip-classic.stage2 .petal,
  .flower.tulip-classic.stage3 .petal{ display:none; }

  /* ç¬¬äºŒé˜¶æ®µï¼šè®©èŠ±è‹æ˜¾ç°ï¼ˆä¿æŒå¶å­ä½ç¼©ï¼‰ */
  .flower.tulip-classic.stage2 .bud-left{ opacity:1; transform: translateX(-78%) rotate(-8deg) scale(1.0); }
  .flower.tulip-classic.stage2 .bud-right{ opacity:1; transform: translateX(-22%) rotate(8deg) scale(1.0); }
  .flower.tulip-classic.stage2 .bud-base{ opacity:1; transform: translateX(-50%) scale(1); }

  /* ç¬¬ä¸‰é˜¶æ®µï¼šå±•å¼€ä¸¤ç‰‡å¶å­åˆ°æœ€ç»ˆå½¢æ€ï¼ˆä½¿ç”¨è¿‡æ¸¡è€ŒéåŠ¨ç”»ç±»ï¼Œé¿å…å›é€€ï¼‰ */
  .flower.tulip-classic.stage3 .leaf-left{
    transform: rotate(var(--leafL-rot, -10deg)) translateX(var(--leafL-tx, -2px)) scale(var(--leafL-scaleFinal, 1));
    opacity:1;
    transition: transform 600ms ease, opacity 600ms ease;
  }
  .flower.tulip-classic.stage3 .leaf-right{
    transform: rotate(var(--leafR-rot, 10deg)) translateX(var(--leafR-tx, 2px)) scale(var(--leafR-scaleFinal, 1));
    opacity:1;
    transition: transform 600ms ease, opacity 600ms ease;
  }

  /* ç¬¬å››é˜¶æ®µï¼šå¼€èŠ±ï¼ˆæ²¿ç”¨ bloom åŠ¨ç”»ï¼‰ */
  .flower.tulip-classic.stage4 { /* å ä½ï¼šå¯ç”¨äºæ•´æœµè½»å¾®æ¼‚æµ® */ }
  .flower.tulip-classic.stage4 .center{ opacity:1; }

  /* è½»å¾®æ‘†åŠ¨ */
  .bloom { animation: float 6s ease-in-out infinite; }
  @keyframes float {
    0% { transform: translateY(0px); }
    50%{ transform: translateY(-4px); }
    100%{ transform: translateY(0px); }
  }

  /* åœç•™è¯†åˆ«é—ªç‚¹ */
  .recognize-dot{
    position: fixed;
    width:10px; height:10px; border-radius:50%;
    background: radial-gradient(circle at 50% 50%, #fff, #ffd1c8);
    box-shadow: 0 0 14px rgba(255,200,200,0.9);
    pointer-events:none; z-index: 9999;
    transform: translate(-50%, -50%);
    animation: dotFlash 600ms ease-out forwards;
  }
  @keyframes dotFlash{
    0% { opacity:0; transform: translate(-50%, -50%) scale(0.5); }
    50%{ opacity:1; transform: translate(-50%, -50%) scale(1.4); }
    100%{ opacity:0; transform: translate(-50%, -50%) scale(0.8); }
  }

  /* å¼€èŠ±å…‰ç¯æ•ˆæœ */
  .bulb .halo{
    position:absolute; left:50%; bottom:6px; transform: translateX(-50%) scale(0.9);
    width:76px; height:76px; border-radius:50%; display:none;
    background: radial-gradient(circle, rgba(255,255,255,0.65) 10%, rgba(255,255,255,0) 60%);
    filter: blur(2px);
    opacity:0;
  }
  @keyframes haloPulse{
    0% { opacity:0; transform: translateX(-50%) scale(0.6); }
    50%{ opacity:0.85; transform: translateX(-50%) scale(1.08); }
    100%{ opacity:0; transform: translateX(-50%) scale(1.28); }
  }
  .flower.tulip-classic.stage4 .halo{ display:block; animation: haloPulse 1200ms ease-out; }

  /* æç¤ºæ–‡æœ¬ */
  .hint{
    position:absolute;
    left:16px; top:16px;
    z-index:20;
    font-size:14px; color:#cfd8e3b3;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:8px 12px; border-radius:10px;
    backdrop-filter: blur(6px);
    pointer-events: auto;
  }
  .hint .close-btn{
    position:absolute; right:6px; top:6px;
    width:22px; height:22px; border-radius:6px;
    appearance:none; border:none; background:transparent; color:#cfd8e3; cursor:pointer;
    line-height:22px; font-size:16px; padding:0;
  }
  .hint .close-btn:hover{ background: rgba(255,255,255,0.08); }
  

</style>
</head>
<body>
<div id="app">
  <video id="webcam" autoplay playsinline></video>
  <canvas id="debug"></canvas>

  <div class="garden" id="garden"></div>
  <div class="ground"></div>

  <div class="hint" id="handytulip-hint">
    <button class="close-btn" id="handytulip-hint-close" aria-label="Close">Ã—</button>
    <span class="hint-zh">æŠŠæ‰‹ä¼¸åˆ°é•œå¤´å‰ï¼š<strong>åœç•™</strong>å¹¶å¼ å¼€äº”æŒ‡å¯åœ¨è¯¥ä½ç½®ç§ä¸‹éƒé‡‘é¦™ ğŸŒ·</span>
    <span class="hint-en" style="display:none;">Put your hand in front of the camera: <strong>hold still</strong> and spread your five fingers to plant a tulip at that position ğŸŒ·</span>
  </div>
</div>

<script type="module">
  import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

  const video = document.getElementById('webcam');
  const debug = document.getElementById('debug');
  const dbgCtx = debug.getContext?.('2d');
  const garden = document.getElementById('garden');

  let handLandmarker = null;
  let lastHandPos = null;
  let stableFrames = 0;
  let lastPlantTime = 0;
  let lastPickTime = 0;
  let pickedFlower = null;
  let activeFlower = null; // å½“å‰æŒ‰é˜¶æ®µæ¨è¿›çš„èŠ±
  const PLANT_COOLDOWN = 800; // ms
  const PICK_COOLDOWN = 600; // ms
  const STABLE_THRESHOLD = 0.015; // normalized distance
  const STABLE_FRAMES_REQUIRED = 16;

  /**
   * ç”Ÿæˆä¸€å¥—éšæœºé…è‰²ï¼Œç”¨äºæ¯æœµèŠ±çš„ CSS å˜é‡ã€‚
   * è¿”å› { petal1, petal2, petal3, leaf, stem }ã€‚
   */
  function randomPalette(){
    const palettes = [
      { petal1:'#ff6b6b', petal2:'#ff8e8e', petal3:'#ff4d6d', leaf:'#2f7d49', stem:'#2a6b45' },
      { petal1:'#f7b267', petal2:'#f79d65', petal3:'#f4845f', leaf:'#2e8b57', stem:'#2a5f3b' },
      { petal1:'#c06c84', petal2:'#f67280', petal3:'#f8b195', leaf:'#3a7f5d', stem:'#316d4e' },
      { petal1:'#ffd166', petal2:'#fdae61', petal3:'#f9c74f', leaf:'#2e8b57', stem:'#256d3a' },
      { petal1:'#9b5de5', petal2:'#f15bb5', petal3:'#fee440', leaf:'#2f8e5b', stem:'#27764a' }
    ];
    return palettes[Math.floor(Math.random()*palettes.length)];
  }

  /**
   * åœ¨ç¨³å®šè§¦å‘æ—¶æ˜¾ç¤ºä¸€ä¸ªé—ªç‚¹æ ‡è®°äºè§†å£ä½ç½®ã€‚
   */
  function flashRecognizeDot(center){
    const vp = normToViewport(center.x, center.y);
    const dot = document.createElement('div');
    dot.className = 'recognize-dot';
    dot.style.left = vp.x + 'px';
    dot.style.top = vp.y + 'px';
    document.body.appendChild(dot);
    setTimeout(()=>{ dot.remove(); }, 620);
  }

  // å®‰å…¨å°è£…ï¼šåœ¨ä¸åŒç¯å¢ƒä¸‹è·å–æ‘„åƒå¤´æµ
  /**
   * ä»¥å…¼å®¹æ–¹å¼è·å–æ‘„åƒå¤´åª’ä½“æµã€‚
   * ä¼˜å…ˆä½¿ç”¨ navigator.mediaDevices.getUserMediaï¼Œ
   * é€€åŒ–åˆ°æ—§çš„ webkit/moz æ¥å£ï¼›æ£€æµ‹éå®‰å…¨ä¸Šä¸‹æ–‡ç»™å‡ºæ˜ç¡®æç¤ºã€‚
   */
  async function getUserMediaSafe(constraints){
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const md = navigator.mediaDevices;
    if (md && typeof md.getUserMedia === 'function'){
      return await md.getUserMedia(constraints);
    }
    const legacy = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    if (legacy){
      return await new Promise((resolve, reject)=>{
        try { legacy.call(navigator, constraints, resolve, reject); } catch(e){ reject(e); }
      });
    }
    const reason = isSecure ? 'å½“å‰æµè§ˆå™¨æœªæä¾›æ‘„åƒå¤´ APIã€‚' : 'è¯·ä½¿ç”¨ https æˆ– localhost æ‰“å¼€é¡µé¢ã€‚';
    throw new Error('æ‘„åƒå¤´ä¸å¯ç”¨ï¼š' + reason);
  }

  // åˆå§‹åŒ–æ‘„åƒå¤´å’Œæ¨¡å‹
  async function init() {
    const vision = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
    );
    handLandmarker = await HandLandmarker.createFromOptions(vision, {
      baseOptions: {
        modelAssetPath: `https://storage.googleapis.com/mediapipe-assets/hand_landmarker.task`
      },
      runningMode: "VIDEO",
      numHands: 1
    });

    try {
      const stream = await getUserMediaSafe({ video: { width:1280, height:720 } });
      video.srcObject = stream;
      await video.play();
    } catch (err) {
      console.error(err);
      // æ˜¾ç¤ºå‹å¥½æç¤ºè¦†ç›–å±‚
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);color:#fff;font:500 14px/1.6 system-ui;z-index:9999;';
      overlay.textContent = 'æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + (err && err.message ? err.message : 'æœªçŸ¥é”™è¯¯');
      document.body.appendChild(overlay);
      // ç»§ç»­è¿è¡Œä¸ä¾èµ–æ‘„åƒå¤´çš„æ¼”ç¤ºï¼ˆæ‰‹åŠ¨æµ‹è¯•å¯ç”¨ï¼‰
      requestAnimationFrame(()=>{});
      return; // é€€å‡ºåˆå§‹åŒ–ï¼Œé¿å…åç»­ä¾èµ–è§†é¢‘å°ºå¯¸çš„é€»è¾‘æŠ¥é”™
    }

    // ä½¿ canvas ä¸è§†é¢‘å°ºå¯¸ä¸€è‡´
    debug.width = video.videoWidth;
    debug.height = video.videoHeight;

    initHint();
    requestAnimationFrame(loop);
    // æ¼”ç¤ºï¼šåœ¨é¡µé¢ä¸­å¤®ç§ä¸€æœµç»å…¸å½¢æ€éƒé‡‘é¦™
    setTimeout(()=>{ if (typeof plantTulipClassic === 'function') { plantTulipClassic(0.5, 0.68); } }, 600);
  }

  // è®¡ç®—æ‰‹ä¸­å¿ƒï¼ˆå¹³å‡å…³é”®ç‚¹ï¼‰
  function handCenter(landmarks) {
    let x = 0, y = 0;
    for (let i=0;i<landmarks.length;i++){ x += landmarks[i].x; y += landmarks[i].y; }
    return { x: x/landmarks.length, y: y/landmarks.length };
  }

  /**
   * è®¡ç®—è™šæ‹Ÿæ‰‹æŒä¸­å¿ƒç‚¹ï¼ˆå½’ä¸€åŒ–åæ ‡ï¼‰
   * ç­–ç•¥ï¼šå–è…•å’Œäº”æŒ‡çš„ MCP å…³èŠ‚ç‚¹ [0,1,5,9,13,17] çš„å¹³å‡å€¼ã€‚
   * è¿”å› {x,y}ï¼ŒèŒƒå›´ 0..1ã€‚
   */
  function palmCenter(landmarks){
    const idxs = [0,1,5,9,13,17];
    let x = 0, y = 0;
    for (const i of idxs){ x += landmarks[i].x; y += landmarks[i].y; }
    const n = idxs.length;
    return { x: x/n, y: y/n };
  }

  /**
   * è®¡ç®—æŒå¿ƒåœˆï¼šä¸­å¿ƒä¸º palmCenterï¼ŒåŠå¾„ä¸ºæŒå¿ƒåˆ° MCP èŠ‚ç‚¹çš„å¹³å‡è·ç¦»çš„æ¯”ä¾‹ã€‚
   * è¿”å› { centerNorm:{x,y}, radiusNorm }ï¼Œå‡ä¸ºå½’ä¸€åŒ–åæ ‡ï¼ˆ0..1ï¼‰ã€‚
   */
  function palmAreaNorm(landmarks){
    const c = palmCenter(landmarks);
    const idxs = [1,5,9,13,17];
    let sum = 0;
    for (const i of idxs){ sum += Math.hypot(landmarks[i].x - c.x, landmarks[i].y - c.y); }
    const avg = sum / idxs.length;
    const radiusNorm = Math.min(0.25, avg * 0.85); // ä¸Šé™é¿å…è¿‡å¤§
    return { centerNorm: c, radiusNorm };
  }

  /**
   * å½’ä¸€åŒ–åæ ‡æ˜ å°„åˆ°è§†å£åæ ‡ï¼ˆè€ƒè™‘é•œåƒï¼‰ï¼šx æ˜ å°„ä¸º (1-x)*viewportWidthã€‚
   */
  function normToViewport(xNorm, yNorm){
    return {
      x: (1 - xNorm) * window.innerWidth,
      y: yNorm * window.innerHeight
    };
  }

  /**
   * è·å–äº”æŒ‡æŒ‡å°–å½’ä¸€åŒ–åæ ‡æ•°ç»„ã€‚
   */
  function fingerTips(landmarks){
    const ids = [4,8,12,16,20];
    return ids.map(i=>({ x: landmarks[i].x, y: landmarks[i].y }));
  }

  /**
   * è®¡ç®—æåˆä¸­ç‚¹ï¼ˆæ‹‡æŒ‡ä¸é£ŸæŒ‡æŒ‡å°–ä¸­ç‚¹ï¼‰ã€‚
   */
  function pinchMidpoint(landmarks){
    const a = landmarks[4], b = landmarks[8];
    return { x: (a.x+b.x)/2, y: (a.y+b.y)/2 };
  }

  /**
   * å•è°ƒé“¾æ³•è®¡ç®—å‡¸åŒ…ï¼ˆè¾“å…¥/è¾“å‡ºå‡ä¸ºç‚¹æ•°ç»„ï¼Œç‚¹å¯¹è±¡å« x,yï¼‰ã€‚
   */
  function convexHull(points){
    const pts = points.slice().sort((p,q)=> p.x===q.x ? p.y-q.y : p.x-q.x);
    if (pts.length<=1) return pts;
    const cross = (o,a,b)=> (a.x-o.x)*(b.y-o.y) - (a.y-o.y)*(b.x-o.x);
    const lower=[]; for (const p of pts){ while(lower.length>=2 && cross(lower[lower.length-2], lower[lower.length-1], p) <= 0) lower.pop(); lower.push(p); }
    const upper=[]; for (let i=pts.length-1;i>=0;i--){ const p=pts[i]; while(upper.length>=2 && cross(upper[upper.length-2], upper[upper.length-1], p) <= 0) upper.pop(); upper.push(p); }
    upper.pop(); lower.pop();
    return lower.concat(upper);
  }

  /**
   * ç‚¹åœ¨å¤šè¾¹å½¢å†…åˆ¤å®šï¼ˆå°„çº¿æ³•ï¼‰ã€‚è¾“å…¥ç‚¹ä¸ polygon é¡»ä¸ºåŒä¸€åæ ‡ç³»ã€‚
   */
  function pointInPolygon(point, polygon){
    let inside = false;
    for (let i=0,j=polygon.length-1;i<polygon.length;j=i++){
      const xi = polygon[i].x, yi = polygon[i].y;
      const xj = polygon[j].x, yj = polygon[j].y;
      const intersect = ((yi>point.y)!=(yj>point.y)) && (point.x < (xj - xi) * (point.y - yi) / (yj - yi + 1e-9) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  /**
   * å°è¯•åœ¨â€œäº”æŒ‡æŒ‡å°–å‡¸åŒ…è¦†ç›–èŒƒå›´â€å†…å¯»æ‰¾æœ€è¿‘çš„èŠ±æœµï¼ˆä»¥æåˆä¸­ç‚¹ä¸ºå‚è€ƒï¼‰ã€‚
   * å‘½ä¸­è¿”å›è¯¥èŠ±å…ƒç´ ï¼Œå¦åˆ™è¿”å› nullã€‚
   */
  function findFlowerWithinFingerCoverage(landmarks){
    const tips = fingerTips(landmarks);
    // æ˜ å°„åˆ°è§†å£åæ ‡
    const tipsVP = tips.map(t=> normToViewport(t.x, t.y));
    const hull = convexHull(tipsVP);
    const mid = pinchMidpoint(landmarks);
    const midVP = normToViewport(mid.x, mid.y);

    const flowers = Array.from(garden.querySelectorAll('.flower'));
    let best = null, bestDist = Infinity;
    for (const f of flowers){
      const bulb = f.querySelector('.bulb');
      if (!bulb) continue;
      const rect = bulb.getBoundingClientRect();
      const c = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
      if (pointInPolygon(c, hull)){
        const d = Math.hypot(c.x - midVP.x, c.y - midVP.y);
        if (d < bestDist){ bestDist = d; best = f; }
      }
    }
    return best;
  }

  /**
   * è®¾å®šæŠ“å–çš„èŠ±æœµï¼Œå¹¶è¿›å…¥è·ŸéšçŠ¶æ€ã€‚
   */
  function pickFlower(f){
    if (!f) return;
    pickedFlower = f;
    f.classList.remove('growing');
    f.classList.remove('bloom');
    f.classList.add('picked');
    f.style.willChange = 'top,left';
  }

  /**
   * æ ¹æ®é”šç‚¹å½’ä¸€åŒ–åæ ‡æ›´æ–°æŠ“å–èŠ±æœµçš„ä½ç½®ï¼ˆè·Ÿéšæ‰‹ï¼‰ã€‚
   */
  function updatePickedFlowerPosition(anchorNorm){
    if (!pickedFlower) return;
    const vp = normToViewport(anchorNorm.x, anchorNorm.y);
    const width = pickedFlower.offsetWidth || 86;
    const left = Math.max(0, Math.min(window.innerWidth - width, vp.x - width/2));
    const top = Math.max(0, Math.min(window.innerHeight - 120, vp.y - 60));
    pickedFlower.style.left = left + 'px';
    pickedFlower.style.top = top + 'px';
  }

  /**
   * é‡Šæ”¾æŠ“å–ï¼ˆä¿ç•™å½“å‰ä½ç½®ï¼‰ã€‚
   */
  function releasePickedFlower(){
    if (!pickedFlower) return;
    pickedFlower.classList.remove('picked');
    pickedFlower.style.willChange = '';
    pickedFlower = null;
  }

  function normDist(a,b){
    return Math.hypot(a.x-b.x, a.y-b.y);
  }

  // è¾…åŠ©ï¼šåˆ¤æ–­æ‰‹æŒ‡æ˜¯å¦å¼ å¼€ï¼ˆé’ˆå¯¹å››æŒ‡ï¼‰
  function fingerExtended(landmarks, tipIdx, pipIdx){
    // åŸºæœ¬å¯å‘å¼ï¼šå¦‚æœæŒ‡å°–åœ¨ pip ä¹‹ä¸Šï¼ˆy æ›´å°ï¼‰ï¼Œåˆ™è®¤ä¸ºä¼¸ç›´ï¼ˆæ‘„åƒå¤´é•œåƒæ—¶ y æ–¹å‘ä¸å˜ï¼‰
    return landmarks[tipIdx].y < landmarks[pipIdx].y;
  }
  function thumbExtended(landmarks){
    // åˆ¤æ–­æ‹‡æŒ‡ï¼šå‘å³/å·¦å¼ å¼€: ä»¥æ‹‡æŒ‡æŒ‡å°–ä¸è…•ï¼ˆ0ï¼‰åœ¨ x ä¸Šçš„è·ç¦»ä¸ºä¾æ®
    const tip = landmarks[4], ip = landmarks[3], mcp = landmarks[2], wrist = landmarks[0];
    return Math.abs(tip.x - wrist.x) > 0.07; // å¯å‘å¼
  }

  function fiveFingersOpen(landmarks){
    // éœ€è¦ 4 æŒ‡å¼ å¼€ + æ‹‡æŒ‡è¾ƒå¼ å¼€
    const idxs = [
      [8,6],  // index tip,pip
      [12,10],// middle
      [16,14],// ring
      [20,18] // pinky
    ];
    let ok = true;
    for (const [t,p] of idxs){
      if (!fingerExtended(landmarks, t, p)) { ok = false; break; }
    }
    return ok && thumbExtended(landmarks);
  }

  /**
   * åœ¨è°ƒè¯•ç”»å¸ƒä¸Šç»˜åˆ¶äº”æŒ‡æŒ‡å°–ä¸æ‰‹æŒä¸­å¿ƒçš„æ ‡è®°ã€‚
   * é¢œè‰²åŒºåˆ†ä¸åŒæ‰‹æŒ‡ï¼Œä¾¿äºè§‚å¯Ÿã€‚
   */
  function drawFingerAndPalmMarkers(ctx, landmarks){
    if (!ctx) return;
    const W = debug.width, H = debug.height;

    // æŒ‡å°–ç´¢å¼•ä¸é¢œè‰²
    const tips = [
      {i:4,  label:'æ‹‡', color:'#ffd166'},
      {i:8,  label:'é£Ÿ', color:'#06d6a0'},
      {i:12, label:'ä¸­', color:'#118ab2'},
      {i:16, label:'æ— ', color:'#ef476f'},
      {i:20, label:'å°', color:'#a78bfa'}
    ];

    ctx.save();
    ctx.lineWidth = 2;
    for (const t of tips){
      const pt = landmarks[t.i];
      const x = pt.x * W, y = pt.y * H;
      ctx.fillStyle = t.color;
      ctx.strokeStyle = t.color + 'cc';
      // åœ†ç‚¹
      ctx.beginPath();
      ctx.arc(x, y, 6, 0, Math.PI*2);
      ctx.fill();
      // æ ‡ç­¾
      ctx.font = '12px system-ui';
      ctx.fillStyle = '#ffffff';
      ctx.strokeStyle = 'rgba(0,0,0,0.35)';
      ctx.lineWidth = 3;
      ctx.strokeText(t.label, x+8, y-8);
      ctx.fillText(t.label, x+8, y-8);
    }

    // æ‰‹æŒä¸­å¿ƒ
    const palm = palmCenter(landmarks);
    const px = palm.x * W, py = palm.y * H;
    ctx.fillStyle = '#00e5ff';
    ctx.beginPath();
    ctx.arc(px, py, 8, 0, Math.PI*2);
    ctx.fill();
    ctx.font = '12px system-ui';
    ctx.fillStyle = '#ffffff';
    ctx.strokeStyle = 'rgba(0,0,0,0.35)';
    ctx.lineWidth = 3;
    ctx.strokeText('æŒ', px+10, py-10);
    ctx.fillText('æŒ', px+10, py-10);

    // æŒå¿ƒåœˆï¼ˆå¯è§†åŒ–æ‘˜å–èŒƒå›´ï¼‰
    const area = palmAreaNorm(landmarks);
    const rPx = Math.min(W, H) * area.radiusNorm;
    ctx.strokeStyle = '#00e5ff88';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(area.centerNorm.x * W, area.centerNorm.y * H, rPx, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  // åˆ›å»ºèŠ±æœµå…ƒç´ ï¼ˆxNorm = 0..1 ç”¨äºæ°´å¹³ä½ç½®ï¼ŒtargetYNorm ç”¨äºé«˜åº¦ç›¸å¯¹åœ°é¢ï¼‰
  /**
   * ç§ä¸‹éƒé‡‘é¦™ï¼šxNorm æ§åˆ¶æ°´å¹³ä½ç½®ï¼ŒtargetYNorm æ§åˆ¶ç›®æ ‡é«˜åº¦ï¼ˆç›¸å¯¹åœ°é¢ï¼‰ã€‚
   * ä¸ºæ»¡è¶³â€œç¨å¾®é«˜ä¸€ç‚¹â€çš„éœ€æ±‚ï¼Œåœ¨è®¡ç®—èŒé«˜åº¦æ—¶åŠ å…¥å°å¹…æå‡ã€‚
   */
  function plantTulip(xNorm, targetYNorm){
    const now = Date.now();
    if (now - lastPlantTime < PLANT_COOLDOWN) return;
    lastPlantTime = now;

    const flower = document.createElement('div');
    flower.className = 'flower growing';
    // å®½åº¦å¯æ ¹æ®éœ€æ±‚è°ƒæ•´
    const width = 86;
    flower.style.width = width + 'px';

    // å°† xNorm è½¬ä¸ºç»å¯¹ä½ç½®ï¼ˆé•œåƒä¿®æ­£ï¼Œå› ä¸ºè§†é¢‘åšäº†é•œåƒï¼‰
    const viewportWidth = window.innerWidth;
    const leftPx = Math.max(20, Math.min(viewportWidth - width - 20, (1 - xNorm) * viewportWidth - width/2));
    flower.style.left = leftPx + 'px';

    // è®¡ç®— target heightï¼ˆ--target-heightï¼‰ï¼Œä»¥ stem çš„é«˜åº¦ç™¾åˆ†æ¯”è¡¨ç¤ºï¼ˆç›¸å¯¹èŠ±å®¹å™¨ heightï¼‰
    // ä¸ºäº†è®©èŠ±é•¿åˆ°æ¥è¿‘æ‰‹çš„é«˜åº¦ï¼Œæˆ‘ä»¬æŠŠ target height æ ¹æ® targetYNorm å–å€¼
    // targetYNorm: 0 (top) .. 1 (bottom). æˆ‘ä»¬å¸Œæœ›èŠ±ç”Ÿé•¿åˆ°ç¦»åœ°é¢ä¸€å®šé«˜åº¦: smaller targetYNorm (æ‰‹é«˜) => taller stem
    const maxStemPercent = 78; // æœ€å¤§é«˜åº¦ï¼ˆ%ï¼‰ç•¥å¾®æé«˜ä¸Šé™
    const minStemPercent = 26; // æœ€å°é«˜åº¦ï¼ˆ%ï¼‰
    const stemBoost = 6;      // é¢å¤–æå‡ï¼ˆ%ï¼‰ï¼Œè®©éƒé‡‘é¦™ç¨å¾®é«˜ä¸€ç‚¹
    // invert targetYNorm so that higher hand yields longer stem
    const t = 1 - targetYNorm;
    let stemPercent = Math.round(minStemPercent + (maxStemPercent - minStemPercent) * Math.min(1, Math.max(0, t)));
    stemPercent = Math.min(maxStemPercent, stemPercent + stemBoost);
    // ç™¾åˆ†æ¯”ç”¨äºåŠ¨ç”»ï¼ŒåŒæ—¶æ¢ç®—åƒç´ é«˜åº¦ä»¥å®šä½èŠ±è‹åœ¨èŒé¡¶
    flower.style.setProperty('--target-height', stemPercent + '%');
    const stemHpx = Math.round((stemPercent / 100) * window.innerHeight);
    flower.style.setProperty('--stem-h', stemHpx + 'px');

    // æ„å»º DOM
    const stem = document.createElement('div'); stem.className = 'stem';
    const leafL = document.createElement('div'); leafL.className = 'leaf-left';
    const leafR = document.createElement('div'); leafR.className = 'leaf-right';
    const bulb = document.createElement('div'); bulb.className = 'bulb';

    // 3 petals
    const p1 = document.createElement('div'); p1.className = 'petal p1';
    const p2 = document.createElement('div'); p2.className = 'petal p2';
    const p3 = document.createElement('div'); p3.className = 'petal p3';
    const center = document.createElement('div'); center.className = 'center';

    bulb.appendChild(p1); bulb.appendChild(p2); bulb.appendChild(p3); bulb.appendChild(center);

    flower.appendChild(stem);
    flower.appendChild(leafL);
    flower.appendChild(leafR);
    flower.appendChild(bulb);

    garden.appendChild(flower);

    // åœ¨ç”Ÿé•¿å®Œæˆåï¼ˆåŠ¨ç”»æ—¶é—´ï¼‰ï¼ŒæŠŠç±»ä» growing åˆ‡æ¢ä¸º bloomï¼ˆç››å¼€ï¼‰æˆ–ä¿ç•™ç­‰å¾…æ‰‹åŠ¿è§¦å‘å¼€èŠ±
    setTimeout(()=>{
      flower.classList.remove('growing');
      // è‡ªåŠ¨å¾®å¾®å±•å¼€å¶å­ä½†ä¿æŒèŠ±è‹çŠ¶æ€
    }, 1000);

    // è¿”å›å¯¹è¯¥ DOM çš„å¼•ç”¨ä»¥ä¾¿åç»­å¼€èŠ±
    return flower;
  }
  /**
   * ç§ä¸‹ç»å…¸å½¢æ€éƒé‡‘é¦™ï¼ˆé—­åˆèŠ±è‹ã€ç»†é•¿å¶ã€æ©™é»„é…è‰²ï¼‰ã€‚
   * xNorm æ§åˆ¶æ°´å¹³ä½ç½®ï¼ŒtargetYNorm æ§åˆ¶é«˜åº¦ã€‚
   */
  function plantTulipClassic(xNorm, targetYNorm){
    const now = Date.now();
    if (now - lastPlantTime < PLANT_COOLDOWN) return;
    lastPlantTime = now;

    const flower = document.createElement('div');
    flower.className = 'flower growing tulip-classic';
    const width = Math.round(74 + Math.random()*20); // 74..94 éšæœºå®¹å™¨å®½åº¦
    flower.style.width = width + 'px';

    const viewportWidth = window.innerWidth;
    const leftPx = Math.max(20, Math.min(viewportWidth - width - 20, (1 - xNorm) * viewportWidth - width/2));
    flower.style.left = leftPx + 'px';

    const maxStemPercent = 82; // æ›´é«˜çš„ä¸Šé™
    const minStemPercent = 28;
    const stemBoost = 8;
    const t = 1 - targetYNorm;
    let stemPercent = Math.round(minStemPercent + (maxStemPercent - minStemPercent) * Math.min(1, Math.max(0, t)));
    // éšæœºé«˜åº¦å¾®è°ƒï¼Œä¿è¯èŠ±é«˜ä¸å®Œå…¨ä¸€è‡´
    const jitter = (Math.random()*8 - 4); // Â±4%
    stemPercent = Math.min(maxStemPercent, Math.max(minStemPercent, stemPercent + stemBoost + jitter));
    flower.style.setProperty('--target-height', stemPercent + '%');
    // è®¡ç®—åƒç´ é«˜åº¦å¹¶å†™å…¥ --stem-hï¼Œç”¨äºèŒä¸èŠ±è‹å®šä½ï¼ˆæœ€é«˜ä¸è¶…è¿‡å±å¹• 2/3ï¼‰
    let stemHpx = Math.round((stemPercent / 100) * window.innerHeight);
    const stemMax = Math.round(window.innerHeight * 0.66);
    stemHpx = Math.min(stemHpx, stemMax);
    flower.style.setProperty('--stem-h', stemHpx + 'px');
    // ä¸ºèŒè®¾ç½®è½»å¾®å¼¯æ›²è§’åº¦
    const bend = (Math.random()*12 - 6); // -6..6 åº¦
    const bendDeg = bend.toFixed(1) + 'deg';
    flower.style.setProperty('--stem-bend', bendDeg);
    // è®¡ç®—èŒé¡¶åœ¨å®¹å™¨åæ ‡ç³»ä¸‹çš„ä½ç§»
    const rad = bend * Math.PI / 180;
    const tipX = Math.sin(rad) * stemHpx;
    const tipY = Math.cos(rad) * stemHpx;
    flower.style.setProperty('--stem-tip-x', tipX.toFixed(1) + 'px');
    flower.style.setProperty('--stem-tip-y', tipY.toFixed(1) + 'px');
    // éšæœºé…è‰²ï¼šå†™å…¥æ¯æœµèŠ±çš„å˜é‡
    const pal = randomPalette();
    flower.style.setProperty('--petal1', pal.petal1);
    flower.style.setProperty('--petal2', pal.petal2);
    flower.style.setProperty('--petal3', pal.petal3);
    flower.style.setProperty('--classic-leaf', pal.leaf);
    flower.style.setProperty('--classic-stem', pal.stem);

    // å¶å­å½¢æ€éšæœºï¼šå¤§å°ã€è§’åº¦ã€ä½ç§»ä¸ç¼©æ”¾
    const leafLw = Math.round(22 + Math.random()*12);
    const leafRw = Math.round(22 + Math.random()*12);
    const leafLh = Math.round(110 + Math.random()*80);
    const leafRh = Math.round(130 + Math.random()*90);
    const leafLRot = (-(4 + Math.random()*10)).toFixed(1) + 'deg'; // -4..-14
    const leafRRot = ((6 + Math.random()*10)).toFixed(1) + 'deg';  // 6..16
    const leafLTx = (-12 + Math.random()*10).toFixed(1) + 'px';    // -12..-2
    const leafRTx = (2 + Math.random()*10).toFixed(1) + 'px';      // 2..12
    const leafLScale = (0.92 + Math.random()*0.16).toFixed(2);
    const leafRScale = (0.92 + Math.random()*0.18).toFixed(2);
    flower.style.setProperty('--leafL-w', leafLw + 'px');
    flower.style.setProperty('--leafR-w', leafRw + 'px');
    flower.style.setProperty('--leafL-h', leafLh + 'px');
    flower.style.setProperty('--leafR-h', leafRh + 'px');
    flower.style.setProperty('--leafL-rot', leafLRot);
    flower.style.setProperty('--leafR-rot', leafRRot);
    flower.style.setProperty('--leafL-tx', leafLTx);
    flower.style.setProperty('--leafR-tx', leafRTx);
    flower.style.setProperty('--leafL-scale', leafLScale);
    flower.style.setProperty('--leafR-scale', leafRScale);
    flower.style.setProperty('--leafL-scaleFinal', 1);
    flower.style.setProperty('--leafR-scaleFinal', 1);

    // èŠ±å¤§å°éšæœºï¼šé€šè¿‡ bulb æ•´ä½“ç¼©æ”¾å®ç°
    const bulbScale = (0.85 + Math.random()*0.45).toFixed(2);
    flower.style.setProperty('--bulb-scale', bulbScale);

    const stem = document.createElement('div'); stem.className = 'stem';
    const leafL = document.createElement('div'); leafL.className = 'leaf-left';
    const leafR = document.createElement('div'); leafR.className = 'leaf-right';
    const bulb = document.createElement('div'); bulb.className = 'bulb';

    const budLeft = document.createElement('div'); budLeft.className = 'bud-left';
    const budRight = document.createElement('div'); budRight.className = 'bud-right';
    const budBase = document.createElement('div'); budBase.className = 'bud-base';
    // é¢å¤–åŠ å…¥ 5 ç‰‡èŠ±ç“£ï¼Œä¾¿äºæœ€ç»ˆå¼€èŠ±æ›´é¥±æ»¡
    const p1 = document.createElement('div'); p1.className = 'petal p1';
    const p2 = document.createElement('div'); p2.className = 'petal p2';
    const p3 = document.createElement('div'); p3.className = 'petal p3';
    const p4 = document.createElement('div'); p4.className = 'petal p4';
    const p5 = document.createElement('div'); p5.className = 'petal p5';
    const center = document.createElement('div'); center.className = 'center';
    const halo = document.createElement('div'); halo.className = 'halo';

    bulb.appendChild(budLeft);
    bulb.appendChild(budRight);
    bulb.appendChild(budBase);
    bulb.appendChild(p1);
    bulb.appendChild(p2);
    bulb.appendChild(p3);
    bulb.appendChild(p4);
    bulb.appendChild(p5);
    bulb.appendChild(center);
    bulb.appendChild(halo);

    flower.appendChild(stem);
    flower.appendChild(leafL);
    flower.appendChild(leafR);
    flower.appendChild(bulb);
    garden.appendChild(flower);

    // åˆå§‹é˜¶æ®µï¼šä»…æ˜¾ç¤ºèŒ
    setStage(flower, 1);
    activeFlower = flower;
    return flower;
  }

  /**
   * è®¾ç½®èŠ±æœµé˜¶æ®µï¼š
   * 1=èŒï¼Œ2=èŠ±è‹ï¼Œ3=ä¸¤ç‰‡å¶å­ï¼Œ4=å¼€èŠ±
   * å°†ç±»åˆ‡æ¢ä¸º stageXï¼Œå¹¶åœ¨é˜¶æ®µ 1/2 ç»™äºˆçŸ­æš‚çš„â€œgrowingâ€ä»¥å¹³æ»‘è¿‡æ¸¡ã€‚
   */
  function setStage(flower, stage){
    if (!flower) return;
    flower.dataset.stage = String(stage);
    flower.classList.remove('stage1','stage2','stage3','stage4','bloom');
    flower.classList.add('stage'+stage);
    // é˜¶æ®µæ€§è¡¥å……åŠ¨ç”»ï¼ˆé¿å…å±æ€§å›é€€çš„é—®é¢˜ï¼ŒèŒå·²ç”¨ --stem-h å›ºåŒ–ï¼‰
    if (stage === 1 || stage === 2){
      flower.classList.add('growing');
      setTimeout(()=>{ flower?.classList.remove('growing'); }, stage === 1 ? 900 : 700);
    }
    if (stage === 4){
      flower.classList.add('bloom');
    }
  }

  /**
   * æ‘˜é™¤æŒå¿ƒèŒƒå›´å†…çš„èŠ±ï¼ˆæåˆè§¦å‘ï¼‰ã€‚
   * è®¡ç®—æŒå¿ƒåœˆåœ¨è§†å£çš„ä¸­å¿ƒä¸åŠå¾„ï¼Œå‘½ä¸­åˆ™å¯¹å‘½ä¸­çš„èŠ±åšæ·¡å‡ºå¹¶ç§»é™¤ã€‚
   * è¿”å›æ˜¯å¦æ‘˜é™¤äº†è‡³å°‘ä¸€æœµã€‚
   */
  function tryPickWithinPalmArea(landmarks){
    const now = Date.now();
    if (now - lastPickTime < PICK_COOLDOWN) return false;

    const area = palmAreaNorm(landmarks);
    const centerVP = normToViewport(area.centerNorm.x, area.centerNorm.y);
    const radiusPx = area.radiusNorm * Math.min(window.innerWidth, window.innerHeight) * 0.9;

    const items = Array.from(garden.querySelectorAll('.flower'));
    let removed = false;
    for (const f of items){
      const bulb = f.querySelector('.bulb');
      if (!bulb) continue;
      const rect = bulb.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const d = Math.hypot(cx - centerVP.x, cy - centerVP.y);
      if (d <= radiusPx){
        // æ·¡å‡ºåŠ¨ç”»åç§»é™¤
        f.style.transition = 'opacity 180ms ease, transform 180ms ease';
        f.style.opacity = '0';
        f.style.transform = 'translateY(12px) scale(0.92)';
        setTimeout(()=>{
          if (f.parentNode === garden) garden.removeChild(f);
        }, 190);
        removed = true;
      }
    }

    if (removed) lastPickTime = now;
    return removed;
  }

  // æŠŠå·²å­˜åœ¨çš„æœ€è¿‘ä¸€æœµèŠ±å¼€èŠ±ï¼ˆæˆ–æŒ‡å®š indexï¼‰
  function bloomLatest(){
    const items = garden.querySelectorAll('.flower');
    if (!items || items.length === 0) return;
    const f = items[items.length-1];
    f.classList.add('bloom');
    // ç¡®ä¿é•¿åº¦/å¤§å°å¹³è¡¡
    setTimeout(()=>{ /* å¯ç”¨äºæ’­æ”¾éŸ³æ•ˆ */ }, 10);
  }

  // ä¸»å¾ªç¯ï¼šæ£€æµ‹æ‰‹åŠ¿å¹¶æ§åˆ¶æ¤ç‰©ç”Ÿé•¿/ç§æ¤/å¼€èŠ±
  async function loop() {
    if (!handLandmarker) { requestAnimationFrame(loop); return; }

    const now = performance.now();
    const result = handLandmarker.detectForVideo(video, now);

    // æ¸… debug canvas
    if (dbgCtx) {
      dbgCtx.clearRect(0,0,debug.width,debug.height);
      // optional: draw mirror video for debug
      // dbgCtx.drawImage(video, 0, 0, debug.width, debug.height);
    }

    if (result && result.landmarks && result.landmarks.length > 0){
      const landmarks = result.landmarks[0];
      const center = handCenter(landmarks); // normalized 0..1

      // ç¨³å®šæ£€æµ‹ï¼ˆç”¨äºâ€œåœç•™â€ï¼‰
      if (lastHandPos && normDist(center, lastHandPos) < STABLE_THRESHOLD) {
        stableFrames++;
      } else {
        stableFrames = 0;
      }
      lastHandPos = center;

      // å¯è§†åŒ–æŒ‡å°–ä¸æ‰‹æŒä¸­å¿ƒ
      drawFingerAndPalmMarkers(dbgCtx, landmarks);

      // åˆ¤æ–­äº”æŒ‡å¼ å¼€
      const five = fiveFingersOpen(landmarks);

      // å½“åœç•™è¶³å¤Ÿå¸§å¹¶ä¸”äº”æŒ‡å¼ å¼€ï¼šæŒ‰ç…§â€œèŒâ†’èŠ±è‹â†’å¶å­â†’å¼€èŠ±â€æ¨è¿›é˜¶æ®µ
      if (stableFrames >= STABLE_FRAMES_REQUIRED && five) {
        // æ˜¾ç¤ºé—ªç‚¹æ ‡è®°å½“å‰è¯†åˆ«ä½ç½®
        flashRecognizeDot(center);
        const stageNow = activeFlower && activeFlower.dataset ? parseInt(activeFlower.dataset.stage || '0', 10) : 0;
        if (!activeFlower || !document.contains(activeFlower) || stageNow >= 4) {
          // ç§ä¸‹ä¸€æœµæ–°èŠ±å¹¶è¿›å…¥é˜¶æ®µ1
          activeFlower = plantTulipClassic(center.x, center.y);
          setStage(activeFlower, 1);
        } else {
          // æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ
          const nextStage = Math.min(stageNow + 1, 4);
          setStage(activeFlower, nextStage);
        }
        stableFrames = 0; // reset ä»¥é¿å…è¿ç»­è·³å¤šé˜¶æ®µ
      }

      // åˆ¤æ–­ OK æ‰‹åŠ¿æˆ–æ¡æ‹³ç­‰æ¥å¼€èŠ±ï¼ˆè¿™é‡Œä¸¾ä¾‹ï¼šå½“äº”æŒ‡å¼ å¼€ -> åŒå‡»å¼å¼€èŠ±ä¼šæ˜¾å¾—æ€ªï¼‰
      // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬æ£€æµ‹â€œé£ŸæŒ‡ä¸æ‹‡æŒ‡æ¥è¿‘â€ä¸ºå¼€èŠ±è§¦å‘ï¼ˆpinchï¼‰
      const thumbTip = landmarks[4], indexTip = landmarks[8];
      const pinchDist = Math.hypot(thumbTip.x-indexTip.x, thumbTip.y-indexTip.y);
      const pinchActive = pinchDist < 0.04;
      if (pinchActive) {
        // è‹¥å°šæœªæŠ“å–ï¼Œå…ˆè¯•å›¾åœ¨æŒ‡å°–å‡¸åŒ…èŒƒå›´æŠ“å–ä¸€æœµèŠ±
        if (!pickedFlower){
          const candidate = findFlowerWithinFingerCoverage(landmarks);
          if (candidate){
            pickFlower(candidate);
          } else {
            // è‹¥æ— å€™é€‰ï¼Œåˆ™ä¿ç•™åŸé€»è¾‘ï¼šä¼˜å…ˆå°è¯•æŒå¿ƒæ‘˜é™¤ï¼Œå¦åˆ™å¼€èŠ±
            const removed = tryPickWithinPalmArea(landmarks);
            if (!removed) bloomLatest();
          }
        }
        // è·Ÿéšæåˆä¸­ç‚¹ä½ç½®
        const anchor = pinchMidpoint(landmarks);
        updatePickedFlowerPosition(anchor);
      } else {
        // æåˆç»“æŸï¼Œé‡Šæ”¾æŠ“å–
        if (pickedFlower){
          releasePickedFlower();
        }
      }

      // å¦ï¼šä¹Ÿå¯ä»¥åœ¨æ£€æµ‹åˆ°â€œä¸‰æŒ‡å‘ä¸Šâ€ç­‰ç‰¹å®šæ‰‹åŠ¿æ—¶å¼€èŠ±
    } else {
      // æ— æ‰‹æ—¶æ¸…é™¤ç¨³å®šè®¡æ•°
      stableFrames = 0;
      lastHandPos = null;
    }

    requestAnimationFrame(loop);
  }

  // å¯åŠ¨
  init().catch(e=>{ console.error(e); alert('æ— æ³•åˆå§‹åŒ–æ‰‹åŠ¿æ¨¡å‹æˆ–æ‘„åƒå¤´ï¼š' + e.message) });

  // å“åº”çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´ canvas & å·²æœ‰èŠ±çš„ä½ç½®ï¼ˆç®€å•ç­–ç•¥ï¼‰
  window.addEventListener('resize', ()=>{
    debug.width = video.videoWidth;
    debug.height = video.videoHeight;
    // å¯é€‰æ‹©é‡æ’èŠ±æœµä½ç½®ï¼ˆæ­¤ç¤ºä¾‹ç®€å•ä¸åšå¤æ‚é‡æ’ï¼‰
  });

  // å¯é€‰ï¼šå¿«æ·é”®å¸®åŠ©ï¼ˆç”¨äºæ¼”ç¤ºåœ¨ä¸è”ç½‘/æ‘„åƒå¤´æ—¶æµ‹è¯•ï¼‰
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'p') {
      // æ‰‹åŠ¨åœ¨ä¸­é—´ç§ç»å…¸éƒé‡‘é¦™ï¼ˆä¾¿äºæµ‹è¯•ï¼‰
      plantTulipClassic(0.5, 0.68);
    } else if (e.key === 'b') {
      bloomLatest();
    }
  });

  // åˆå§‹åŒ–æç¤ºçš„è¯­è¨€ä¸å¯å…³é—­è¡Œä¸º
  function initHint(){
    const hint = document.getElementById('handytulip-hint');
    const zh = hint?.querySelector('.hint-zh');
    const en = hint?.querySelector('.hint-en');
    const closeBtn = document.getElementById('handytulip-hint-close');
    const lang = (localStorage.getItem('language') || 'zh').toLowerCase();
    const closed = localStorage.getItem('handytulip_hint_closed') === '1';
    if (closed && hint) { hint.style.display = 'none'; return; }
    if (en && zh) {
      if (lang.startsWith('en')) { en.style.display = 'inline'; zh.style.display = 'none'; }
      else { zh.style.display = 'inline'; en.style.display = 'none'; }
    }
    closeBtn?.addEventListener('click', ()=>{
      if (hint) hint.style.display = 'none';
      localStorage.setItem('handytulip_hint_closed','1');
    });
  }

</script>
</body>
</html>
